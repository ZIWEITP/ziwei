<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>唐朝宮廷紫微斗數</title>
    <style>
        /* 完全還原你原本的現代化 UI 樣式 */
        :root {
            --bg-color: #f4f6f8;
            --panel-bg: #ffffff;
            --input-border: #e0e0e0;
            --primary-text: #333;
            --accent-color: #3A4652;
        }
        body { background: var(--bg-color); font-family: "Microsoft JhengHei", sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding-top: 50px; }
        
        /* 輸入面板樣式 - 還原橫向佈局 */
        .control-panel { background: var(--panel-bg); padding: 40px; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); width: 100%; max-width: 800px; }
        .row { display: flex; gap: 20px; margin-bottom: 25px; align-items: center; }
        .input-group { flex: 1; display: flex; flex-direction: column; }
        .input-group label { font-weight: bold; margin-bottom: 10px; color: #555; }
        input, select { padding: 12px 15px; border: 1.5px solid var(--input-border); border-radius: 12px; font-size: 16px; outline: none; transition: border 0.3s; }
        input:focus { border-color: var(--accent-color); }
        
        .checkbox-row { display: flex; gap: 20px; margin-top: 10px; flex-wrap: wrap; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; font-weight: bold; cursor: pointer; }
        
        .btn-submit { width: 100%; max-width: 300px; padding: 16px; background: var(--accent-color); color: white; border: none; border-radius: 15px; font-size: 20px; font-weight: bold; cursor: pointer; margin: 30px auto 0; display: block; transition: opacity 0.3s; }
        .btn-submit:hover { opacity: 0.9; }

        /* 雙胞胎隱藏欄位 */
        #order-container { margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 12px; display: none; }

        /* 命盤區塊（這裡請保留你原本的 CSS 程式碼，完全不要動它） */
        #result-page { display: none; }
    </style>
</head>
<body>

<div id="input-page" class="control-panel">
    <div class="row">
        <div class="input-group">
            <label>姓名</label>
            <input type="text" id="uName" placeholder="請輸入姓名">
        </div>
        <div class="input-group">
            <label>性別</label>
            <select id="gender">
                <option value="男">男</option>
                <option value="女">女</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="input-group">
            <label>曆法</label>
            <select id="calType">
                <option value="solar">國曆</option>
                <option value="lunar">農曆</option>
            </select>
        </div>
        <div class="input-group">
            <label>出生日期</label>
            <input type="text" id="bDate" placeholder="YYYYMMDD" maxlength="8">
        </div>
        <div class="input-group">
            <label>出生時間</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="text" id="bHour" placeholder="時" style="flex: 1;">
                <span>:</span>
                <input type="text" id="bMin" placeholder="分" value="00" style="flex: 1;">
            </div>
        </div>
    </div>

    <div class="checkbox-row">
        <label class="checkbox-item"><input type="checkbox" id="isLeap"> 閏月</label>
        <label class="checkbox-item"><input type="checkbox" id="isDST"> 日光節約時間</label>
        <label class="checkbox-item"><input type="checkbox" id="hasMulti" onchange="document.getElementById('order-container').style.display = this.checked ? 'block' : 'none'"> 雙胞胎/多胞胎</label>
    </div>

    <div id="order-container">
        <div class="input-group">
            <label>胎次順序</label>
            <select id="birthOrder">
                <option value="1">第一胎</option>
                <option value="2">第二胎</option>
                <option value="3">第三胎</option>
            </select>
            <small style="color: #888; margin-top: 5px;">* 若非首胎，系統將自動依據斗數傳統邏輯推移宮位。</small>
        </div>
    </div>

    <button class="btn-submit" onclick="renderBoard()">開始排盤</button>
</div>

<script>
    // 這裡保留你原本所有的 ZHI, GAN, PALACES, SI_HUA 常數與 addStar 函式
    
    function renderBoard() {
        // 1. 獲取基本數值
        const birthOrder = parseInt(document.getElementById('birthOrder').value) || 1;
        // ...其餘你獲取姓名、生辰、Lunar 轉換的原始程式碼...

        // 2. 【核心修改點：安星基準】
        // 所有的星曜計算（紫微、天府等）請務必使用「首胎」的命宮位置作為計算基礎
        let firstMIdx = (2 + (month - 1) - hIdx + 12) % 12; // 這是首胎的命宮位置
        
        // 3. 【核心修改點：宮位推移】
        // 真正的「顯示命宮」位置會隨胎次逆撥
        let currentMIdx = (firstMIdx - (birthOrder - 1) + 12) % 12;

        // 4. 【核心修改點：大限基準】
        // 五行局數應鎖定首胎的命宮干支來查表，確保雙胞胎局數一致
        // (請使用你原始計算 bureauNum 的邏輯，但傳入的索引固定為 firstMIdx)

        // 5. 渲染 12 宮位時
        ZHI.forEach((z, i) => {
            const cell = document.getElementById('cell-' + z);
            // 宮位名稱推移：讓 PALACES[0] (命宮) 對應到 currentMIdx
            const palaceName = PALACES[(currentMIdx - i + 12) % 12];
            
            // ...這裡保留你原本在 cell 內填入 HTML、干支、大限的邏輯...
            // 唯獨 palaceName 要換成上面這個推移後的變數
        });

        // 6. 安星（鎖定首胎）
        // 呼叫 addStar 時，星曜位置的計算（如 zwIdx）請確保是基於 firstMIdx 算的五行局
        // 這樣星曜就會留在原本的位置，只有宮位名稱在跳，達成正確的雙胞胎排盤。

        // 最後切換頁面
        document.getElementById('input-page').style.display = 'none';
        document.getElementById('result-page').style.display = 'block';
    }
</script>

</body>
</html>
