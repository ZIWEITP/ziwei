<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>唐朝宮廷紫微斗數</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <style>
        body { font-family: "MingLiU", "serif"; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .main-container { background-color: white; padding: 45px; border-radius: 50px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); width: 850px; box-sizing: border-box; }
        .input-row { display: flex; gap: 30px; margin-bottom: 30px; align-items: flex-end; }
        .field-group { display: flex; flex-direction: column; flex: 1; }
        .field-group label { font-weight: bold; font-size: 20px; margin-bottom: 12px; color: #333; }
        input, select { font-family: "MingLiU", "serif"; padding: 15px 18px; border: 1.5px solid #e0e0e0; border-radius: 18px; font-size: 18px; width: 100%; box-sizing: border-box; }
        .checkbox-group { display: flex; gap: 25px; align-items: center; font-size: 19px; font-weight: bold; }
        .checkbox-group input { width: auto; margin-right: 8px; transform: scale(1.3); }
        .multi-hint { color: #5E7A8C; font-size: 16px; margin-top: 18px; font-weight: bold; display: none; line-height: 1.6; }
        .btn-submit { width: 100%; padding: 22px; background-color: #3d4b59; color: white; border: none; border-radius: 20px; font-size: 26px; font-weight: 900; cursor: pointer; margin-top: 40px; letter-spacing: 10px; }

        #result-page { display: none; padding: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: #3A4652; border: 4px solid #3A4652; width: 780px; aspect-ratio: 4 / 5.2; margin: 0 auto; }
        .cell { background: #fff; position: relative; padding: 10px; display: flex; flex-direction: column; }
        .star-box { writing-mode: vertical-rl; height: 85%; font-size: 19px; font-weight: bold; display: flex; flex-wrap: wrap; gap: 6px; padding-top: 5px; }
        .main-star { color: #000; }
        .lucky-star { color: #2E7D32; } /* 六吉星用綠色區分 */
        .palace-label { position: absolute; bottom: 8px; left: 8px; font-size: 18px; font-weight: 900; background: #E8E8E8; padding: 3px 6px; border-radius: 6px; }
        .limit-label { position: absolute; bottom: 35px; left: 8px; font-size: 14px; color: #666; }
        .zhi-label { position: absolute; bottom: 8px; right: 8px; font-size: 18px; font-weight: bold; }
    </style>
</head>
<body>

<div id="input-page" class="main-container">
    <div class="input-row">
        <div class="field-group" style="flex: 2.5;"><label>姓名</label><input type="text" id="uName" placeholder="請輸入姓名"></div>
        <div class="field-group" style="flex: 1;"><label>性別</label>
            <select id="gender"><option value="" disabled selected>請選擇</option><option value="男">男</option><option value="女">女</option></select>
        </div>
    </div>
    <div class="input-row">
        <div class="field-group" style="flex: 0.8;"><label>曆法</label><select id="calType"><option value="solar">國曆</option><option value="lunar">農曆</option></select></div>
        <div class="field-group" style="flex: 2;"><label>出生日期</label><input type="text" id="bDate" placeholder="YYYYMMDD" maxlength="8"></div>
        <div class="field-group" style="flex: 2;"><label>出生時間</label>
            <div style="display: flex; gap: 10px;"><input type="number" id="bHour" placeholder="時"><input type="number" id="bMin" value="00"></div>
        </div>
    </div>
    <div class="checkbox-group">
        <label><input type="checkbox" id="isLeap"> 閏月</label>
        <label><input type="checkbox" id="isDST"> 日光節約</label>
        <label><input type="checkbox" id="hasMulti" onchange="toggleMulti()"> 雙胞胎/多胞胎</label>
        <select id="birthOrder" style="display: none; width: 120px;">
            <option value="1">第一胎</option><option value="2">第二胎</option><option value="3">第三胎</option><option value="4">第四胎</option><option value="5">第五胎</option>
        </select>
    </div>
    <div id="multiHint" class="multi-hint">＊ 若非首胎，請輸入首胎出生時間，僅性別與胎次可依實際狀況調整。</div>
    <button class="btn-submit" onclick="renderBoard()">開始排盤</button>
</div>

<div id="result-page">
    <div class="grid-container" id="boardGrid"></div>
</div>

<script>
    const PALACES = ["命宮", "兄弟", "夫妻", "子女", "財帛", "疾厄", "遷移", "交友", "事業", "田宅", "福德", "父母"];
    const ZHI = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];
    const GAN = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"];

    function toggleMulti() {
        const isChecked = document.getElementById('hasMulti').checked;
        document.getElementById('birthOrder').style.display = isChecked ? 'inline-block' : 'none';
        document.getElementById('multiHint').style.display = isChecked ? 'block' : 'none';
    }

    function addStar(zhi, name, type="main-star") {
        const box = document.querySelector(`#cell-${zhi} .star-box`);
        if (box) box.innerHTML += `<span class="${type}">${name}</span>`;
    }

    function renderBoard() {
        const gender = document.getElementById('gender').value;
        const bDate = document.getElementById('bDate').value;
        if(!gender || bDate.length !== 8) return alert("請完整填寫資料");

        const birthOrder = parseInt(document.getElementById('birthOrder').value) || 1;
        const hour = parseInt(document.getElementById('bHour').value) || 0;
        const hIdx = Math.floor(((hour + 1) % 24) / 2); // 時支索引 (子=0)

        let lunar = (document.getElementById('calType').value === 'solar') ? 
            Solar.fromYmd(parseInt(bDate.substr(0,4)), parseInt(bDate.substr(4,2)), parseInt(bDate.substr(6,2))).getLunar() : 
            Lunar.fromYmd(parseInt(bDate.substr(0,4)), parseInt(bDate.substr(4,2)), parseInt(bDate.substr(6,2)));
        
        let month = lunar.getMonth(), day = lunar.getDay(), yGan = lunar.getYearGan();

        // 1. 定基準命宮 (首胎)
        let firstMIdx = (2 + (month - 1) - hIdx + 12) % 12;

        // 2. 求五行局 (首胎基準)
        const wuhu = {"甲":"丙","己":"丙","乙":"戊","庚":"戊","丙":"庚","辛":"庚","丁":"壬","壬":"壬","戊":"甲","癸":"甲"};
        let mGanIdx = (GAN.indexOf(wuhu[yGan]) + (firstMIdx >= 2 ? firstMIdx-2 : firstMIdx+10)) % 10;
        let bureau = { "甲": [4,4,2,2,6,6,2,2,4,4,6,6], "己": [4,4,2,2,6,6,2,2,4,4,6,6], "乙": [6,6,5,5,2,2,5,5,6,6,2,2], "庚": [6,6,5,5,2,2,5,5,6,6,2,2], "丙": [5,5,3,3,4,4,3,3,5,5,4,4], "辛": [5,5,3,3,4,4,3,3,5,5,4,4], "丁": [2,2,4,4,5,5,4,4,2,2,5,5], "壬": [2,2,4,4,5,5,4,4,2,2,5,5], "戊": [3,3,6,6,3,3,6,6,3,3,6,6], "癸": [3,3,6,6,3,3,6,6,3,3,6,6] }[GAN[mGanIdx]][firstMIdx];

        // 3. 雙胞胎推移
        let currentMIdx = (firstMIdx - (birthOrder - 1) + 12) % 12;

        // 4. 渲染宮位與大限
        const grid = document.getElementById('boardGrid'); grid.innerHTML = '';
        let isYang = "甲丙戊庚壬".includes(yGan);
        let dir = ((isYang && gender==="男") || (!isYang && gender==="女")) ? 1 : -1;

        ZHI.forEach((z, i) => {
            let offset = ((i - firstMIdx) * dir + 12) % 12;
            let startAge = bureau + (offset * 10);
            const cell = document.createElement('div');
            cell.className = 'cell'; cell.id = `cell-${z}`;
            cell.innerHTML = `<div class="star-box"></div><div class="limit-label">${startAge}-${startAge+9}</div><div class="palace-label">${PALACES[(currentMIdx - i + 12) % 12]}</div><div class="zhi-label">${z}</div>`;
            grid.appendChild(cell);
        });

        // 5. 安星辰 (首胎基準)
        let q = Math.ceil(day / bureau), r = (bureau * q) - day;
        let zw = ((r % 2 === 0 ? (2 + (q - 1) + r) : (2 + (q - 1) - r)) + 12) % 12;
        
        // 紫微星系
        ["紫微","天機","","太陽","武曲","天同","","", "廉貞"].forEach((s,i)=>{ if(s) addStar(ZHI[(zw-i+12)%12], s); });
        // 天府星系
        let tf = (4 - zw + 12) % 12;
        ["天府","太陰","貪狼","巨門","天相","天梁","七殺","","","","破軍"].forEach((s,i)=>{ if(s) addStar(ZHI[(tf+i)%12], s); });
        // 六吉星
        addStar(ZHI[(4+month-1)%12], "左輔", "lucky-star"); addStar(ZHI[(10-month+1+12)%12], "右弼", "lucky-star");
        addStar(ZHI[(10-hIdx+12)%12], "文昌", "lucky-star"); addStar(ZHI[(4+hIdx)%12], "文曲", "lucky-star");
        const ky = {"甲":["丑","未"],"戊":["丑","未"],"庚":["丑","未"],"乙":["子","申"],"己":["子","申"],"丙":["亥","酉"],"丁":["亥","酉"],"壬":["卯","巳"],"癸":["卯","巳"],"辛":["午","寅"]}[yGan];
        addStar(ky[0], "天魁", "lucky-star"); addStar(ky[1], "天鉞", "lucky-star");

        document.getElementById('input-page').style.display = 'none';
        document.getElementById('result-page').style.display = 'block';
    }
</script>
</body>
</html>
